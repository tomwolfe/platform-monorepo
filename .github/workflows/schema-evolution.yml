name: Schema Evolution - Auto Migration PR

on:
  workflow_dispatch:
    inputs:
      proposal_id:
        description: "Schema evolution proposal ID to process"
        required: true
        type: string
  schedule:
    # Run every 6 hours to check for pending proposals
    - cron: '0 */6 * * *'

jobs:
  check-proposals:
    name: Check Pending Proposals
    runs-on: ubuntu-latest
    outputs:
      has_proposals: ${{ steps.check.outputs.has_proposals }}
      proposal_ids: ${{ steps.check.outputs.proposal_ids }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8.15.9
      
      - name: Install dependencies
        run: pnpm install
      
      - name: Check for pending proposals
        id: check
        env:
          UPSTASH_REDIS_REST_URL: ${{ secrets.UPSTASH_REDIS_REST_URL }}
          UPSTASH_REDIS_REST_TOKEN: ${{ secrets.UPSTASH_REDIS_REST_TOKEN }}
          PROPOSAL_ID: ${{ github.event.inputs.proposal_id }}
        run: |
          node scripts/check-schema-proposals.js
        continue-on-error: true

  generate-migration:
    name: Generate Migration
    runs-on: ubuntu-latest
    needs: check-proposals
    if: needs.check-proposals.outputs.has_proposals == 'true'
    strategy:
      matrix:
        proposal_id: ${{ fromJson(needs.check-proposals.outputs.proposal_ids) }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8.15.9
      
      - name: Install dependencies
        run: pnpm install
      
      - name: Generate migration
        id: generate
        env:
          UPSTASH_REDIS_REST_URL: ${{ secrets.UPSTASH_REDIS_REST_URL }}
          UPSTASH_REDIS_REST_TOKEN: ${{ secrets.UPSTASH_REDIS_REST_TOKEN }}
          PROPOSAL_ID: ${{ matrix.proposal_id }}
        run: |
          node scripts/generate-schema-migration.js
        continue-on-error: true
      
      - name: Upload migration artifact
        uses: actions/upload-artifact@v4
        if: steps.generate.outputs.success == 'true'
        with:
          name: migration-${{ matrix.proposal_id }}
          path: packages/database/drizzle/*.ts
          retention-days: 7

  create-pr:
    name: Create Pull Request
    runs-on: ubuntu-latest
    needs: [check-proposals, generate-migration]
    if: needs.check-proposals.outputs.has_proposals == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Download migration artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: migration-*
          merge-multiple: true
          path: packages/database/drizzle/
      
      - name: Setup Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
      
      - name: Create migration branch
        id: create_branch
        env:
          PROPOSAL_ID: ${{ matrix.proposal_id }}
        run: |
          BRANCH_NAME="schema-evolution/${{ env.PROPOSAL_ID }}-$(date +%Y%m%d-%H%M%S)"
          git checkout -b "$BRANCH_NAME"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
      
      - name: Commit migration files
        run: |
          git add packages/database/drizzle/
          git commit -m "feat: auto-generate schema migration for proposal ${{ matrix.proposal_id }}" || echo "No changes to commit"
      
      - name: Push branch
        run: |
          git push origin "${{ steps.create_branch.outputs.branch_name }}"
      
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: "${{ steps.create_branch.outputs.branch_name }}"
          title: "ðŸ”„ Schema Evolution: Auto-generated migration for proposal ${{ matrix.proposal_id }}"
          body: |
            ## Auto-Generated Schema Migration
            
            This PR was automatically generated by the Schema Evolution system.
            
            ### Proposal Details
            - **Proposal ID:** ${{ matrix.proposal_id }}
            - **Generated:** ${{ github.event.repository.updated_at }}
            - **Type:** Schema Evolution
            
            ### Changes
            - Auto-generated Drizzle migration files
            - Schema change proposal attached
            
            ### Review Checklist
            - [ ] Review the schema changes for correctness
            - [ ] Verify migration is safe for production
            - [ ] Check for potential data loss
            - [ ] Test migration on staging environment
            - [ ] Approve proposal in schema evolution dashboard
            
            ### Commands
            ```bash
            # Run migration locally
            pnpm db:migrate
            
            # Rollback if needed
            pnpm db:rollback
            ```
            
            ---
            *This PR was created automatically by the Schema Evolution GitHub Action*
          labels: |
            schema-evolution
            auto-generated
            database
          draft: false
